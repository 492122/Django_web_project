/*------------------------------------------------------------------
[Master Custom JS] - [Table of contents]
1. Sidebar functionality
2. Megamenu functionality
3. Search functionality
4. Scroll to top
5. Developer Mode Stuff
 */
jQuery(document).ready(function ($) {
    "use strict";
    // jQuery('[data-toggle="tooltip"]').tooltip(); 
    // SET CUSTOM background-image 
    jQuery('.data_background').each(function () {
        var bgurl = jQuery(this).attr('data-background');
        jQuery(this).css('background-image', 'url(' + bgurl + ')');
    });
    /*---------------------------------------------*/
    /*--- 1. Sidebar functionality ---*/
    /*---------------------------------------------*/
    /* Sidebar variables */
    var CURRENT_URL = window.location.href.split("#")[0].split("?")[0],
        $BODY = $("body"),
        $MENU_TOGGLE = $("#menu_toggle"),
        $SIDEBAR_MENU = $("#sidebar-menu"),
        $SIDEBAR_FOOTER = $(".sidebar-footer"),
        $LEFT_COL = $(".left_col"),
        $RIGHT_COL = $(".right_col"),
        $NAV_MENU = $(".nav_menu"),
        $FOOTER = $("footer"),
        randNum = function () {
            return Math.floor(21 * Math.random()) + 20
        };
    /* Sidebar function */
    function init_sidebar() {
        var a = function () {
            $RIGHT_COL.css("min-height", $(window).height());
            var a = $BODY.outerHeight(),
                b = $BODY.hasClass("footer_fixed") ? -10 : $FOOTER.height(),
                c = $LEFT_COL.eq(1).height() + $SIDEBAR_FOOTER.height(),
                d = a < c ? c : a;
            d -= $NAV_MENU.height() + b, $RIGHT_COL.css("min-height", d)
        };
        $SIDEBAR_MENU.find("a").on("click", function (b) {
            var c = $(this).parent();
            c.is(".active") ? (c.removeClass("active active-sm"), $("ul:first", c).slideUp(function () {
                a()
            })) : (c.parent().is(".child_menu") ? $BODY.is(".nav-sm") && ($SIDEBAR_MENU.find("li").removeClass("active active-sm"), $SIDEBAR_MENU.find("li ul").slideUp()) : ($SIDEBAR_MENU.find("li").removeClass("active active-sm"), $SIDEBAR_MENU.find("li ul").slideUp()), c.addClass("active"), $("ul:first", c).slideDown(function () {
                a()
            }))
        }), $MENU_TOGGLE.on("click", function () {
            $BODY.hasClass("nav-md") ? ($SIDEBAR_MENU.find("li.active ul").hide(), $SIDEBAR_MENU.find("li.active").addClass("active-sm").removeClass("active")) : ($SIDEBAR_MENU.find("li.active-sm ul").show(), $SIDEBAR_MENU.find("li.active-sm").addClass("active").removeClass("active-sm")), $BODY.toggleClass("nav-md nav-sm"), a()
        }), $SIDEBAR_MENU.find('a[href="' + CURRENT_URL + '"]').parent("li").addClass("current-page"), $SIDEBAR_MENU.find("a").filter(function () {
            return this.href === CURRENT_URL
        }).parent("li").addClass("current-page").parents("ul").slideDown(function () {
            a()
        }).parent().addClass("active"), a(), $.fn.mCustomScrollbar && $(".menu_fixed").mCustomScrollbar({
            autoHideScrollbar: !0,
            theme: "minimal",
            mouseWheel: {
                preventDefault: !0
            }
        })
    }
    /* Sidebar toggle icon submenu */
    $(".nav-md .container.body #sidebar-menu ul li , .top_nav .navbar-left li a").on("click", function () {
        $(this).find('span.fa').toggleClass('fa-angle-down fa-angle-up');
    });
    init_sidebar();
    /*---------------------------------------------*/
    /*--- 2. Megamenu functionality ---*/
    /*---------------------------------------------*/
    //Menu Aim

    $.fn.menuAim = function (opts) {
        // Initialize menu-aim for all elements in jQuery collection
        this.each(function () {
            init.call(this, opts);
        });
        return this;
    };
    function init(opts) {
        var $menu = $(this),
            activeRow = null,
            mouseLocs = [],
            lastDelayLoc = null,
            timeoutId = null,
            options = $.extend({
                rowSelector: "> li",
                submenuSelector: "*",
                submenuDirection: "right",
                tolerance: 75,  // bigger = more forgivey when entering submenu
                enter: $.noop,
                exit: $.noop,
                activate: $.noop,
                deactivate: $.noop,
                exitMenu: $.noop
            }, opts);
        var MOUSE_LOCS_TRACKED = 3,  // number of past mouse locations to track
            DELAY = 300;  // ms delay when user appears to be entering submenu
        /**
         * Keep track of the last few locations of the mouse.
         */
        var mousemoveDocument = function (e) {
            mouseLocs.push({ x: e.pageX, y: e.pageY });
            if (mouseLocs.length > MOUSE_LOCS_TRACKED) {
                mouseLocs.shift();
            }
        };
        /**
         * Cancel possible row activations when leaving the menu entirely
         */
        var mouseleaveMenu = function () {
            if (timeoutId) {
                clearTimeout(timeoutId);
            }
            // If exitMenu is supplied and returns true, deactivate the
            // currently active row on menu exit.
            if (options.exitMenu(this)) {
                if (activeRow) {
                    options.deactivate(activeRow);
                }
                activeRow = null;
            }
        };
        /**
         * Trigger a possible row activation whenever entering a new row.
         */
        var mouseenterRow = function () {
            if (timeoutId) {
                // Cancel any previous activation delays
                clearTimeout(timeoutId);
            }
            options.enter(this);
            possiblyActivate(this);
        },
            mouseleaveRow = function () {
                options.exit(this);
            };
        /*
         * Immediately activate a row if the user clicks on it.
         */
        var clickRow = function () {
            activate(this);
        };
        /**
         * Activate a menu row.
         */
        var activate = function (row) {
            if (row === activeRow) {
                return;
            }
            if (activeRow) {
                options.deactivate(activeRow);
            }
            options.activate(row);
            activeRow = row;
        };
        var possiblyActivate = function (row) {
            var delay = activationDelay();
            if (delay) {
                timeoutId = setTimeout(function () {
                    possiblyActivate(row);
                }, delay);
            } else {
                activate(row);
            }
        };
        var activationDelay = function () {
            if (!activeRow || !$(activeRow).is(options.submenuSelector)) {
                return 0;
            }
            var offset = $menu.offset(),
                upperLeft = {
                    x: offset.left,
                    y: offset.top - options.tolerance
                },
                upperRight = {
                    x: offset.left + $menu.outerWidth(),
                    y: upperLeft.y
                },
                lowerLeft = {
                    x: offset.left,
                    y: offset.top + $menu.outerHeight() + options.tolerance
                },
                lowerRight = {
                    x: offset.left + $menu.outerWidth(),
                    y: lowerLeft.y
                },
                loc = mouseLocs[mouseLocs.length - 1],
                prevLoc = mouseLocs[0];
            if (!loc) {
                return 0;
            }
            if (!prevLoc) {
                prevLoc = loc;
            }
            if (prevLoc.x < offset.left || prevLoc.x > lowerRight.x ||
                prevLoc.y < offset.top || prevLoc.y > lowerRight.y) {
                return 0;
            }
            if (lastDelayLoc &&
                loc.x === lastDelayLoc.x && loc.y === lastDelayLoc.y) {
                return 0;
            }
            function slope(a, b) {
                return (b.y - a.y) / (b.x - a.x);
            };
            var decreasingCorner = upperRight,
                increasingCorner = lowerRight;
            if (options.submenuDirection === "left") {
                decreasingCorner = lowerLeft;
                increasingCorner = upperLeft;
            } else if (options.submenuDirection === "below") {
                decreasingCorner = lowerRight;
                increasingCorner = lowerLeft;
            } else if (options.submenuDirection === "above") {
                decreasingCorner = upperLeft;
                increasingCorner = upperRight;
            }
            var decreasingSlope = slope(loc, decreasingCorner),
                increasingSlope = slope(loc, increasingCorner),
                prevDecreasingSlope = slope(prevLoc, decreasingCorner),
                prevIncreasingSlope = slope(prevLoc, increasingCorner);
            if (decreasingSlope < prevDecreasingSlope &&
                increasingSlope > prevIncreasingSlope) {
                lastDelayLoc = loc;
                return DELAY;
            }
            lastDelayLoc = null;
            return 0;
        };
        /**
         * Hook up initial menu events
         */
        $menu
            .mouseleave(mouseleaveMenu)
            .find(options.rowSelector)
            .mouseenter(mouseenterRow)
            .mouseleave(mouseleaveRow)
            .click(clickRow);
        $(document).mousemove(mousemoveDocument);
    };
    //Menu Aim
    //Megamenu main
    //open/close mega-navigation
    $('.megamenu-dropdown-trigger').on('click', function (event) {
        event.preventDefault();
        toggleNav();
    });
    $(window).on('mouseup', function (e) {
        var container = $(".megamenu-dropdown-trigger, .megamenu-dropdown");
        if (!container.is(e.target) && container.has(e.target).length === 0) {
            $('.megamenu-dropdown').removeClass('dropdown-is-active');
            $('.megamenu-dropdown-trigger').removeClass('dropdown-is-active');
        }
    });
    //close meganavigation
    $('.megamenu-dropdown .megamenu-close').on('click', function (event) {
        event.preventDefault();
        toggleNav();
    });
    //on mobile - open submenu
    $('.has-children').children('a').on('click', function (event) {
        //prevent default clicking on direct children of .has-children 
        event.preventDefault();
        var selected = $(this);
        selected.next('ul').removeClass('is-hidden').end().parent('.has-children').parent('ul').addClass('move-out');
    });
    //on desktop - differentiate between a user trying to hover over a dropdown item vs trying to navigate into a submenu's contents
    var submenuDirection = (!$('.megamenu-dropdown-wrapper').hasClass('open-to-left')) ? 'right' : 'left';
    $('.megamenu-dropdown-content').menuAim({
        activate: function (row) {
            $(row).children().addClass('is-active').removeClass('fade-out');
            if ($('.megamenu-dropdown-content .fade-in').length === 0) $(row).children('ul').addClass('fade-in');
        },
        deactivate: function (row) {
            $(row).children().removeClass('is-active');
            if ($('li.has-children:hover').length === 0 || $('li.has-children:hover').is($(row))) {
                $('.megamenu-dropdown-content').find('.fade-in').removeClass('fade-in');
                $(row).children('ul').addClass('fade-out')
            }
        },
        exitMenu: function () {
            $('.megamenu-dropdown-content').find('.is-active').removeClass('is-active');
            return true;
        },
        submenuDirection: submenuDirection,
    });
    //submenu items - go back link
    $('.go-back').on('click', function () {
        var selected = $(this),
            visibleNav = $(this).parent('ul').parent('.has-children').parent('ul');
        selected.parent('ul').addClass('is-hidden').parent('.has-children').parent('ul').removeClass('move-out');
    });
    function toggleNav() {
        var navIsVisible = (!$('.megamenu-dropdown').hasClass('dropdown-is-active')) ? true : false;
        $('.megamenu-dropdown').toggleClass('dropdown-is-active', navIsVisible);
        $('.megamenu-dropdown-trigger').toggleClass('dropdown-is-active', navIsVisible);
        if (!navIsVisible) {
            $('.megamenu-dropdown').one('webkitTransitionEnd otransitionend oTransitionEnd msTransitionEnd transitionend', function () {
                $('.has-children ul').addClass('is-hidden');
                $('.move-out').removeClass('move-out');
                $('.is-active').removeClass('is-active');
            });
        }
    }
    //IE9 placeholder fallback
    //credits http://www.hagenburger.net/BLOG/HTML5-Input-Placeholder-Fix-With-jQuery.html
    if (!Modernizr.input.placeholder) {
        $('[placeholder]').focus(function () {
            var input = $(this);
            if (input.val() === input.attr('placeholder')) {
                input.val('');
            }
        }).blur(function () {
            var input = $(this);
            if (input.val() === '' || input.val() === input.attr('placeholder')) {
                input.val(input.attr('placeholder'));
            }
        }).blur();
        $('[placeholder]').parents('form').submit(function () {
            $(this).find('[placeholder]').each(function () {
                var input = $(this);
                if (input.val() === input.attr('placeholder')) {
                    input.val('');
                }
            })
        });
    }
    //Megamenu main
    /*---------------------------------------------*/
    /*--- 3. Search functionality ---*/
    /*---------------------------------------------*/
    if ($('.search').length) {
        var mainContainer = document.querySelector('.search-wrap'),
            openCtrl = document.getElementById('btn-search'),
            closeCtrl = document.getElementById('btn-search-close'),
            searchContainer = document.querySelector('.search'),
            inputSearch = searchContainer.querySelector('.search__input');
        function initSearch() {
            initEventsSearch();
        }
        function initEventsSearch() {
            openCtrl.addEventListener('click', openSearch);
            closeCtrl.addEventListener('click', closeSearch);
            document.addEventListener('keyup', function (ev) {
                // escape key.
                if (ev.keyCode === 27) {
                    closeSearch();
                }
            });
        }
        function openSearch() {
            mainContainer.classList.add('main-wrap--move');
            searchContainer.classList.add('search--open');
            setTimeout(function () {
                inputSearch.focus();
            }, 600);
        }
        function closeSearch() {
            mainContainer.classList.remove('main-wrap--move');
            searchContainer.classList.remove('search--open');
            inputSearch.blur();
            inputSearch.value = '';
        }
        initSearch();
    }


    /*---------------------------------------------*/
    /*--- 4. Scroll to top ---*/
    /*---------------------------------------------*/
    $(window).scroll(function () {
        if ($(this).scrollTop() > 100) {
            $('.scrollToTop').fadeIn();
        } else {
            $('.scrollToTop').fadeOut();
        }
    });
    $('.scrollToTop').on('click', function () {
        $('html, body').animate({ scrollTop: 0 }, 800);
        return false;
    });
    /*---------------------------------------------*/
    /*--- 5. Developer Mode Stuff ---*/
    /*---------------------------------------------*/
    if (jQuery("body").hasClass("developer-mode")) {
        console.log('Developer Mode: ON');
        // Current Site Url
        var thispage_outside = jQuery(location).attr('href');
        thispage_outside = thispage_outside.substr(0, thispage_outside.lastIndexOf("/"));
        // NIGHT MODE SWITCHER
        jQuery(".button-night-mode .btn-toggle").on("click", function () {
            var nightModeBtn = jQuery(this);
            if (nightModeBtn.hasClass('active')) {
                jQuery('body').removeClass('night-mood-background');
                console.log('Night Mode: OFF');
            } else {
                jQuery('body').addClass('night-mood-background');
                jQuery("head").append('<link href="' + thispage_outside + '/static/css/night-mode.css" rel="stylesheet">');
                console.log('Night Mode: ON');
            }
        });

        // START AJAX get file content
        jQuery.ajax({
            url: thispage_outside + "/static/plugins/mt-skin-switcher/skin-switcher.html",
            context: document.body,
            success: function (response) {
                // Add HTML
                jQuery("body").append(response);
                // console.log('Success'+response);
                // Current Site Url
                var thispage = jQuery(location).attr('href');
                thispage = thispage.substr(0, thispage.lastIndexOf("/"));
                // Get website url
                // console.log(thispage);
                jQuery("head").append('<link href="' + thispage + '/static/plugins/mt-skin-switcher/skin-switcher.css" rel="stylesheet">');
                // jQuery("body").append('<script src="https://modeltheme.com/html-templates/cryptic/assets/plugins/mt-skin-switcher/skin-switcher.js"></script>');
                // Current Skin url
                var currectLinkHref = jQuery('#ui-current-skin').attr('href');
                currectLinkHref = currectLinkHref.substr(0, currectLinkHref.lastIndexOf("/"));
                // SKIN SWITCHER
                jQuery(".colors_buttons > span").on("click", function () {
                    var newSkinName = jQuery(this).attr('data-skin');
                    var newSkinCssHref = currectLinkHref + '/' + newSkinName;

                    // SET THE NEW STYLE
                    jQuery('#ui-current-skin').attr("href", newSkinCssHref);
                    jQuery(".colors_buttons > span").removeClass('currentStyle');
                    jQuery(this).addClass('currentStyle');
                    // LOG
                    // console.log( 'New Skin Applied: '+jQuery( this ).attr('data-skin') );
                });
                // SIDEBAR OPENER
                jQuery(".panel_button .toggle_sidebar").click(function () {
                    jQuery("div#panel").animate({
                        right: "0px"
                    }, "fast");
                    jQuery(".panel_button").animate({
                        right: "300px"
                    }, "fast");
                    jQuery(".panel_button").toggle();
                });
                jQuery(".hide_button.hide_button").click(function () {
                    jQuery("#panel").animate({
                        right: "-300px"
                    }, "fast");
                    jQuery(".panel_button").animate({
                        right: "0px"
                    }, "fast");
                    jQuery(".panel_button").toggle();
                });

                // GOOGLE ANALYTICS
                (function (i, s, o, g, r, a, m) {
                    i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
                        (i[r].q = i[r].q || []).push(arguments)
                    }, i[r].l = 1 * new Date(); a = s.createElement(o),
                        m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
                })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
                ga('create', 'UA-116847160-1', 'auto');
                ga('send', 'pageview');

            },
            error: function (response) {
                console.log('Error' + response);
            }
        });
    }
});

